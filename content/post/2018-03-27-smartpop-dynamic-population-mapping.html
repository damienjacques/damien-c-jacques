---
title: Smartpop - Dynamic Population Mapping
author: Damien C. Jacques
date: '2018-03-27'
slug: smartpop-dynamic-population-mapping
categories:
  - R
tags:
  - population
  - mobile phone data
---

<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="/rmarkdown-libs/pymjs/pym.v1.js"></script>
<script src="/rmarkdown-libs/widgetframe-binding/widgetframe.js"></script>


<p>This Notebook details the steps of the analysis of the Dynamic Population WP of the Smartpop project.</p>
<div id="data-exploration" class="section level2">
<h2>Data Exploration</h2>
<pre class="r"><code>library(data.table)

Mobile_Phone &lt;- fread(&quot;/home/ubuntu/Dropbox/Research/Projects/SMARTPOP/Data/MobilePhone/OBE_traffic_per_antenna_201405_201504.csv&quot;)</code></pre>
<pre><code>## 
Read 0.0% of 40194140 rows
Read 11.8% of 40194140 rows
Read 23.1% of 40194140 rows
Read 34.1% of 40194140 rows
Read 44.7% of 40194140 rows
Read 55.0% of 40194140 rows
Read 65.2% of 40194140 rows
Read 75.4% of 40194140 rows
Read 84.5% of 40194140 rows
Read 93.9% of 40194140 rows
Read 40194140 rows and 7 (of 7) columns from 1.472 GB file in 00:00:12</code></pre>
<pre class="r"><code>Mobile_Phone</code></pre>
<pre><code>##               DATE_HOUR CELL_BTS_XCOORD_NUM CELL_BTS_YCOORD_NUM NBR_SIM_BE
##        1: 2014-05-01 00               24625              200309         22
##        2: 2014-05-01 00               24626              200309         32
##        3: 2014-05-01 00               25332              200658         33
##        4: 2014-05-01 00               25333              200658         48
##        5: 2014-05-01 00               26040              198822         10
##       ---                                                                 
## 40194136: 2015-04-30 23              279799              124673         81
## 40194137: 2015-04-30 23              280464              134506          9
## 40194138: 2015-04-30 23              283963              124090         24
## 40194139: 2015-04-30 23              285244              109939          0
## 40194140: 2015-04-30 23              286300              126350         56
##           NBR_SIM_ROAMERS NBR_EVENTS_BE NBR_EVENTS_ROAMERS
##        1:               2            77                  3
##        2:               6            50                 23
##        3:               3            71                 12
##        4:               3           117                  7
##        5:               0            34                  0
##       ---                                                 
## 40194136:               7           199                 24
## 40194137:              13            19                 45
## 40194138:               1           108                  2
## 40194139:               3             0                  9
## 40194140:               8           144                 20</code></pre>
<div id="antenna" class="section level3">
<h3>Antenna</h3>
<p>How many antennas in the database ?</p>
<pre class="r"><code>unique_antenna &lt;- unique(Mobile_Phone[, c(&quot;CELL_BTS_XCOORD_NUM&quot; ,&quot;CELL_BTS_YCOORD_NUM&quot;)])

nrow(unique_antenna)</code></pre>
<pre><code>## [1] 5261</code></pre>
<p>Plot these antennas.</p>
<pre class="r"><code>library(rgdal)

antenna_shp &lt;- SpatialPointsDataFrame(unique_antenna[ , 1:2], data.frame(ID = 1:nrow(unique_antenna)))

plot(antenna_shp, pch = &quot;*&quot;)</code></pre>
<p><img src="/post/2018-03-27-smartpop-dynamic-population-mapping_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>Two antennas are mislocated, we will discard them. We have now 5259 antennas.</p>
<pre class="r"><code>library(raster)
library(rgeos)

crs(antenna_shp) &lt;- CRS(&quot;+init=epsg:31370&quot;) # Lambert 72 proj !! NOT EQUAL to EPSG:31300 or EPSG:103300. Made some test to find the good one.

belgium &lt;- getData(&#39;GADM&#39;, country = &#39;BE&#39;, level = 0)
belgium &lt;- spTransform(belgium, crs(antenna_shp))
belgium &lt;- gBuffer(belgium, width = 5000)  # Buffer to get all antennas close to belgium border

antenna_discarded &lt;- antenna_shp[which(!gIntersects(antenna_shp, belgium, byid=TRUE)), ]
antenna_shp &lt;- antenna_shp[which(gIntersects(antenna_shp, belgium, byid=TRUE)), ]

plot(antenna_shp, pch= &quot;*&quot;) +
plot(antenna_discarded, add=T, col=&quot;red&quot;, pch = &quot;*&quot;)  # to be sure the buffer was large enough</code></pre>
<p><img src="/post/2018-03-27-smartpop-dynamic-population-mapping_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<pre><code>## integer(0)</code></pre>
<pre class="r"><code>nrow(antenna_shp@data)</code></pre>
<pre><code>## [1] 5259</code></pre>
<p>Comparison with the cadastre (from <a href="http://geoapps.wallonie.be/antennes/#BBOX=-45890.77766488868,367190.77766488865,-12341.35551604438,197672.0853441707">Walloon Region</a>) shows that several antennas from cadaster are not in the db and the other way around.</p>
<pre class="r"><code>cadastre_antenna &lt;- readOGR(&quot;/home/ubuntu/Dropbox/Research/Projects/SMARTPOP/Data/Cadastre_antenna/antenna_orange_cadastre_31370.shp&quot;)</code></pre>
<pre><code>## OGR data source with driver: ESRI Shapefile 
## Source: &quot;/home/ubuntu/Dropbox/Research/Projects/SMARTPOP/Data/Cadastre_antenna/antenna_orange_cadastre_31370.shp&quot;, layer: &quot;antenna_orange_cadastre_31370&quot;
## with 1966 features
## It has 17 fields</code></pre>
<pre class="r"><code>crs(cadastre_antenna) &lt;- CRS(&quot;+init=epsg:31370&quot;)
cadastre_antenna &lt;- spTransform(cadastre_antenna, crs(antenna_shp))

belgium &lt;- getData(&#39;GADM&#39;, country=&#39;BE&#39;, level=4)
liege &lt;- belgium[belgium$NAME_4==&quot;Liège&quot;,]
liege &lt;- spTransform(liege, crs(antenna_shp))

plot(liege, main = &quot;antennas from cadastre + database&quot;) +
plot(cadastre_antenna, pch=&quot;*&quot;, col=&quot;red&quot;, add=T) +
plot(antenna_shp, pch=&quot;*&quot;, add=T)</code></pre>
<p><img src="/post/2018-03-27-smartpop-dynamic-population-mapping_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<pre><code>## integer(0)</code></pre>
<pre class="r"><code># plot(liege, main = &quot;antennas from cadastre&quot;) +
# plot(cadastre_antenna, pch=&quot;*&quot;, col=&quot;red&quot;, add=T)

# plot(liege, main = &quot;antennas from database&quot;) +
# plot(antenna_shp, pch=&quot;*&quot;, add=T)</code></pre>
<p>Leaflet plot for dynamic exploration.</p>
<pre class="r"><code>library(leaflet)
library(widgetframe)

antenna_latlon &lt;- spTransform(antenna_shp, CRS(&quot;+init=epsg:4326&quot;))
antenna_latlon &lt;- data.frame(lat=coordinates(antenna_latlon)[ , 2], lon=coordinates(antenna_latlon)[ , 1])

cadastre_latlon &lt;- spTransform(cadastre_antenna, CRS(&quot;+init=epsg:4326&quot;))
cadastre_latlon &lt;- data.frame(lat=coordinates(cadastre_latlon)[ , 2], lon=coordinates(cadastre_latlon)[ , 1])

l &lt;- leaflet() %&gt;%
  setView(lng = 3.410255, lat = 50.62723, zoom = 12) %&gt;%
  # Base groups
  addProviderTiles(providers$Stamen.Toner, group = &quot;Toner&quot;) %&gt;%
  addTiles(group = &quot;OSM (default)&quot;) %&gt;%
  addProviderTiles(providers$Esri.WorldImagery, group = &quot;ESRI World Imagery&quot;) %&gt;%
  # Overlay groups
  addCircles(data = antenna_latlon, ~lon, ~lat,  weight = 5,
             color=&quot;blue&quot;, fillOpacity = 0.9, group = &quot;antenna db&quot;) %&gt;%
  addCircles(data = cadastre_latlon, ~lon, ~lat,  weight = 5,
             color=&quot;red&quot;, fillOpacity = 0.9, group = &quot;antenna cadastre&quot;) %&gt;%
  # Layers control
  addLayersControl(
    baseGroups = c(&quot;Toner&quot;, &quot;OSM (default)&quot;, &quot;ESRI World Imagery&quot;),
    overlayGroups = c(&quot;antenna db&quot;, &quot;antenna cadastre&quot;),
    options = layersControlOptions(collapsed = FALSE)
  )
frameWidget(l)</code></pre>
<div id="htmlwidget-1" style="width:100%;height:480px;" class="widgetframe html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"url":"/post/2018-03-27-smartpop-dynamic-population-mapping_files/figure-html//widgets/widget_unnamed-chunk-6.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
<p>After exploration some cluster of very close antenna exist. Let’s further investigate this point.</p>
<p>First, we compute the distance matrix between each antenna.</p>
<pre class="r"><code>library(geosphere)
library(reshape)

dt &lt;- expand.grid.df(antenna_latlon[, c(&quot;lon&quot;, &quot;lat&quot;)], antenna_latlon[, c(&quot;lon&quot;, &quot;lat&quot;)])
names(dt)[3:4] &lt;- c(&quot;lon_dest&quot;, &quot;lat_dest&quot;)
dt$dist &lt;- distGeo(matrix(c(dt$lon, dt$lat), ncol = 2), 
                   matrix(c(dt$lon_dest, dt$lat_dest), ncol = 2))
save(dt, file = &quot;/home/ubuntu/Dropbox/Research/Projects/SMARTPOP/Data/WorkingDataBase/antenna_distance&quot;, compress = T)

dt.cad &lt;- expand.grid.df(cadastre_latlon[, c(&quot;lon&quot;, &quot;lat&quot;)], cadastre_latlon[, c(&quot;lon&quot;, &quot;lat&quot;)])
names(dt.cad)[3:4] &lt;- c(&quot;lon_dest&quot;, &quot;lat_dest&quot;)
dt.cad$dist &lt;- distGeo(matrix(c(dt.cad$lon, dt.cad$lat), ncol = 2), 
                   matrix(c(dt.cad$lon_dest, dt.cad$lat_dest), ncol = 2))
save(dt.cad, file = &quot;/home/ubuntu/Dropbox/Research/Projects/SMARTPOP/Data/WorkingDataBase/cadastre_distance&quot;, compress = T)</code></pre>
<p>Then, we explore the histogram of distances between antennas from the cadastre:</p>
<pre class="r"><code>load(&quot;/home/ubuntu/Dropbox/Research/Projects/SMARTPOP/Data/WorkingDataBase/cadastre_distance&quot;)

range(dt.cad$dist[dt.cad$dist &gt; 0])</code></pre>
<pre><code>## [1] 3.605757e+00 2.489118e+05</code></pre>
<pre class="r"><code>hist(dt.cad$dist[dt.cad$dist &gt; 0 &amp; dt.cad$dist &lt; 50], xlab = &quot;Distance between points&quot;, main = &quot;&quot;)</code></pre>
<p><img src="/post/2018-03-27-smartpop-dynamic-population-mapping_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<pre class="r"><code>length(dt.cad$dist[dt.cad$dist &gt; 0 &amp; dt.cad$dist &lt; 50])/length(dt.cad$dist[dt.cad$dist &gt; 0])</code></pre>
<pre><code>## [1] 8.28331e-06</code></pre>
<p>Now, let’s plot the number of antennas over time.</p>
</div>
</div>
